<!DOCTYPE html>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Destiny Dashboard</title>

<div id="root"></div>

<script src="https://unpkg.com/react@15/dist/react.min.js"></script>
<script src="https://unpkg.com/react-dom@15/dist/react-dom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
<script src="account.js"></script>
<script src="apikey.js"></script>
<script src="auth.js"></script>
<script src="bungie.js"></script>
<script src="bungieNetPlatform.js"></script>

<script type="text/babel">
class App extends React.Component {
  constructor(props) {
    super(props);
    this.state = {};
  }

  render() {
    if (window.location.search == '?apidemo')
      return <APIDemo/>;
    else if (!this.state.account)
      return <ChooseAccount app={this}/>;
    else
      return <Account account={this.state.account}/>;
  }
}


class ChooseAccount extends React.Component {
  constructor(props) {
    super(props);
    this.state = {};
  }

  render() {
    if (!this.state.q && !this.state.r) {
      return <div>
        Hi! Who would you like to look up?<br/>
        <form onSubmit={e => {
          e.preventDefault();
          this.setState({q: e.target.children[0].value, r: null});
        }}>
          <input placeholder="PSN username/XBL gamertag"/>
        </form>
        <button onClick={e => {
          e.preventDefault();
          bungie.auth.login()
            .then(bungieNetPlatform.userService.GetCurrentBungieAccount)
            .then(response => this.setState({r: response.destinyAccounts.map(account => account.userInfo)}));
        }}>Login</button>
      </div>;
    }

    if (!this.state.r) {
      bungieNetPlatform.destinyService.SearchDestinyPlayer('all', this.state.q)
          .then(r => this.setState({r}));
      return <span>Searching for <code>{this.state.q}</code>.</span>;
    }

    if (!this.state.r.length)
      return <span>No results for <code>{this.state.q}</code>.</span>;

    if (this.state.r.length > 1) {
      return <ul>
        {this.state.r.map(result => <li>
          <img src={'https://www.bungie.net' + result.iconPath}/>
          <button onClick={e => {
            e.preventDefault();
            this.setState({r: [result]});
          }}>{result.displayName}</button>
        </li>)}
      </ul>;
    }

    bungie.Account.load(this.state.r[0].membershipType, this.state.r[0].membershipId)
        .then(account => this.props.app.setState({account}));
    return <span>Retrieving <code>{this.state.r[0].displayName}</code>.</span>;
  }
}


class Account extends React.Component {
  render() {
    const account = this.props.account;
    return <ul>
      <li>
        Bungie user <code>{account.bungieNetUser.displayName}</code> (account <code>{account.bungieNetUser.membershipId}/254</code>):
        <ul>
          {account.destinyAccounts.map(account => <li>
            Destiny user <code>{account.userInfo.displayName}</code> (account <code>{account.userInfo.membershipId}/{account.userInfo.membershipType}</code>):
            <ul>
              {account.characters.map(character => <li>
                Character <code>{character.characterId}</code>
                <Inventory character={character}/>
              </li>)}
              <li>
                Vault
                <Inventory account={account}/>
              </li>
            </ul>
          </li>)}
        </ul>
      </li>
    </ul>;
  }
}


class Inventory extends React.Component {
  constructor(props) {
    super(props);
    this.state = {};
  }

  render() {
    if (!this.state.itemTree) {
      if (this.props.account) {
        this.props.account.getVaultItemsTree().then(itemTree => this.setState({itemTree}));
        return <div>Loading vault.</div>;
      } else if (this.props.character) {
        this.props.character.getItemsTree().then(itemTree => this.setState({itemTree}));
        return <div>Loading character inventory.</div>;
      } else
        return <div>Unknown inventory source.</div>;
    }

    const itemTree = this.state.itemTree;

    return <ul>
      <li>Quests: {renderNestedObject(itemTree.Invisible.Quests)}</li>
      <li>Bounties: {renderNestedObject(itemTree.Item.Bounties)}</li>
      <li>Equipment: {renderNestedObject(itemTree.Equippable)}</li>
      <li>Ornaments: {renderNestedObject(itemTree.Item.Ornaments)}</li>
      <li>Consumables: {renderNestedObject(itemTree.Item.Consumables)}</li>
      <li>Materials: {renderNestedObject(itemTree.Item.Materials)}</li>
      <li>Mission Items: {renderNestedObject(itemTree.Item.Mission)}</li>
    </ul>;
  }
}


class APIDemo extends React.Component {
  render() {
    const promises = [
        [bungieNetPlatform.destinyService.GetAccount(2, '4611686018436064455', {definitions: true}), 'GetAccount'],
        [bungieNetPlatform.destinyService.GetAccountSummary(2, '4611686018436064455', {definitions: true}), 'GetAccountSummary'],
        [bungieNetPlatform.destinyService.GetAllItemsSummary(2, '4611686018436064455', {definitions: true}), 'GetAllItemsSummary'],
        [bungieNetPlatform.destinyService.GetVault(2, {definitions: true}), 'GetVault'],
        [bungieNetPlatform.destinyService.GetVaultSummary(2, {definitions: true}), 'GetVaultSummary'],
        [bungieNetPlatform.destinyService.GetCharacter(2, '4611686018436064455', '2305843009223046587', {definitions: true}), 'GetCharacter'],
        [bungieNetPlatform.destinyService.GetCharacterSummary(2, '4611686018436064455', '2305843009223046587', {definitions: true}), 'GetCharacterSummary'],
        [bungieNetPlatform.destinyService.GetCharacterInventory(2, '4611686018436064455', '2305843009223046587', {definitions: true}), 'GetCharacterInventory'],
        [bungieNetPlatform.destinyService.GetCharacterInventorySummary(2, '4611686018436064455', '2305843009223046587', {definitions: true}), 'GetCharacterInventorySummary'],
    ];

    return <table>
      <thead>
        <tr>{promises.map(([promise, title]) => {
          return <th>{title}</th>;
        })}</tr>
      </thead>
      <tbody>
        <tr>{promises.map(([promise, title]) => {
          return <APIDemoTD promise={promise}/>;
        })}</tr>
      </tbody>
    </table>;
  }
}


class APIDemoTD extends React.Component {
  constructor(props) {
    super(props);
    this.state = {};
  }

  render() {
    if (this.state.data) {
      const allItems = countAllItems(this.state.data);
      const uniqueItems = countUniqueItems(this.state.data);
      return <td style={{border: '1px solid black', 'vertical-align': 'top', 'white-space': 'nowrap'}}>
        {renderNestedObject(this.state.data)}<br/>
        <br/>
        All itemIds: {allItems}<br/>
        Unique itemIds: {uniqueItems.size}<br/>
        <br/>
        {Array.from(uniqueItems).sort().map(name => <div>{name}</div>)}
      </td>;
    }

    this.props.promise.then(data => this.setState({data: data.data}));
    return <td style={{'vertical-align': 'top'}}>Loading...</td>;
  }
}


function countAllItems(data) {
  var ret = 0;
  if ((data instanceof Object) && !(data instanceof Array)) {
    if (data.itemHash)
      ret++;
    data = Object.values(data);
  }
  if (data instanceof Array)
    ret += data.map(item => countAllItems(item)).reduce((a, b) => a + b, 0);
  return ret;
}


function countUniqueItems(data, seen=new Set()) {
  if ((data instanceof Object) && !(data instanceof Array)) {
    if (data.itemHash)
      seen.add(bungie.DEFS.items[data.itemHash].itemName);
    data = Object.values(data);
  }
  if (data instanceof Array)
    data.map(item => countUniqueItems(item, seen)).reduce((a, b) => a + b, 0);
  return seen;
}


function renderNestedObject(data) {
  if (data instanceof Array) {
    if (!data.length)
      return <span>[]</span>;
    return <span><button onClick={e => {let s = e.target.nextElementSibling.style; s.display = s.display ? '' : 'none';}}>*</button> [<ol style={{display: 'none'}}>
      {data.map(v => <li>{renderNestedObject(v)}</li>)}
    </ol>]</span>;
  } else if (data instanceof Object) {
    if (!Object.keys(data).length)
      return <span>{'{}'}</span>;
    return <span><button onClick={e => {let s = e.target.nextElementSibling.style; s.display = s.display ? '' : 'none';}}>*</button> {'{'}<ul style={{display: 'none'}}>
      {Object.entries(data).sort().map(([k, v]) => <li>{k}: {renderNestedObject(v)}</li>)}
    </ul>{'}'}</span>;
  } else
    return <span>{JSON.stringify(data)}</span>;
}


bungie.init(API_KEY, API_AUTH_URL)
    .then(bungie.auth.init)
    .then(function() {
      ReactDOM.render(<App/>, document.getElementById('root'));
    });
</script>
