<!DOCTYPE html>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Destiny Dashboard</title>

<div id="root"></div>

<script src="https://unpkg.com/react@15/dist/react.min.js"></script>
<script src="https://unpkg.com/react-dom@15/dist/react-dom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
<script src="account.js"></script>
<script src="apikey.js"></script>
<script src="auth.js"></script>
<script src="bungie.js"></script>
<script src="bungieNetPlatform.js"></script>

<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<style>
body {
  background-color: rgb(18, 23, 28);
  color: white;
  font-family: 'Roboto', sans-serif;
  font-size: 16px;
  font-weight: 400;
}

td, th {
  vertical-align: top;
}

div.placard {
  font-size: 12px;
  height: 59px;
  margin: 2px;
  position: relative;
  width: 285px;
}

div.placard > div {
  background-color: rgb(30, 36, 43);
  box-shadow: 0 0 5px 1px rgba(0, 0, 0, 0.5);
}

div.placard.active > div {
  background-color: rgb(60, 72, 86);
  box-shadow: 0 0 5px 1px rgba(245, 245, 245, 0.5);
}

div.placard.neutral > div {
  background-color: rgb(30, 36, 43);
}

div.placard > div:first-child {
  border-top-left-radius: 5px;
  border-top-right-radius: 5px;
}

div.placard > div:last-child {
  border-bottom-left-radius: 5px;
  border-bottom-right-radius: 5px;
}

div.placard > div.content {
  background-size: 100% 100%;
  height: 59px;
  overflow: hidden;
}

div.placard > div.content > img {
  float: left;
  height: 59px;
  margin-right: 4px;
}

div.placard > div.content > div.text {
  font-size: 13px;
  font-weight: 200;
}

div.placard > div.content > div.title {
  font-size: 18px;
  padding: 4px;
  position: relative;
  white-space: nowrap;
}

div.placard > div.content > div.right {
  font-size: 18px;
  padding: 4px;
  position: absolute;
  right: 0;
  height: 100%;
  text-align: right;
  top: 0;
}

div.placard > div.drawer {
  border-top-right-radius: 5px;
  min-height: 59px;
  min-width: 285px;
  overflow: hidden;
  padding: 10px;
  position: absolute;
  top: 59px;
  z-index: 1;
}

div.grid-node > img {
  background-color: rgb(51, 56, 63);
  border: 5px solid rgb(70, 75, 81);
  border-radius: 96px;
  height: 96px;
  width: 96px;
}

div.grid-node.active > img {
  background-color: rgb(72, 135, 186);
  border-color: rgb(72, 135, 186);
}

div.grid-node.unlocked > img {
  border-color: rgb(94, 161, 106);
}

div.grid-node.hidden > img {
  background-color: red;
}
</style>

<script type="text/babel">
class App extends React.Component {
  constructor(props) {
    super(props);
    this.state = {};
  }

  render() {
    if (window.location.search == '?apidemo')
      return <APIDemo/>;
    else if (!this.state.account)
      return <ChooseAccount app={this}/>;
    else
      return <Account account={this.state.account}/>;
  }
}


class ChooseAccount extends React.Component {
  constructor(props) {
    super(props);
    this.state = {};
  }

  render() {
    if (!this.state.q && !this.state.r) {
      return <div>
        Hi! Who would you like to look up?<br/>
        <form onSubmit={e => {
          e.preventDefault();
          this.setState({q: e.target.children[0].value, r: null});
        }}>
          <input placeholder="PSN username/XBL gamertag"/>
        </form>
        <button onClick={e => {
          e.preventDefault();
          bungie.auth.login()
            .then(bungieNetPlatform.userService.GetCurrentBungieAccount)
            .then(response => this.setState({r: response.destinyAccounts.map(account => account.userInfo)}));
        }}>Login</button>
      </div>;
    }

    if (!this.state.r) {
      bungieNetPlatform.destinyService.SearchDestinyPlayer('all', this.state.q)
          .then(r => this.setState({r}));
      return <span>Searching for <code>{this.state.q}</code>.</span>;
    }

    if (!this.state.r.length)
      return <span>No results for <code>{this.state.q}</code>.</span>;

    if (this.state.r.length > 1) {
      return <ul>
        {this.state.r.map(result => <li>
          <img src={'https://www.bungie.net' + result.iconPath}/>
          <button onClick={e => {
            e.preventDefault();
            this.setState({r: [result]});
          }}>{result.displayName}</button>
        </li>)}
      </ul>;
    }

    bungie.Account.load(this.state.r[0].membershipType, this.state.r[0].membershipId)
        .then(account => this.props.app.setState({account}));
    return <span>Retrieving <code>{this.state.r[0].displayName}</code>.</span>;
  }
}


class Account extends React.Component {
  constructor(props) {
    super(props);
    this.account = this.props.account.destinyAccounts[0];
    this.promises = this.account.characters.map(character => character.getItemsTree());
    this.promises.push(this.account.getVaultItemsTree());
    this.promises.forEach(promise => promise.then(data => {
      for (let [category, buckets] of Object.entries(data)) {
        if (category == 'Currency')
          continue;  // Currency items are returned as part of the inventory for each character.
        Object.keys(buckets).forEach(bucket => {
          for (let [category2, bucket2] of this.state.buckets)
            if ((category == category2) && (bucket == bucket2))
              return;
          this.setState(prev => ({buckets: prev.buckets.concat([[category, bucket]])}));
        });
      }
    }));
    this.state = {
        buckets: [
            ['Invisible', 'Quests'],
            ['Item', 'Bounties'],
            ['Equippable', 'Subclass'],
            ['Equippable', 'Primary Weapons'],
            ['Equippable', 'Special Weapons'],
            ['Equippable', 'Heavy Weapons'],
            ['Equippable', 'Ghost'],
            ['Equippable', 'Helmet'],
            ['Equippable', 'Gauntlets'],
            ['Equippable', 'Chest Armor'],
            ['Equippable', 'Leg Armor'],
            ['Equippable', 'Class Armor'],
            ['Equippable', 'Artifacts'],
            ['Equippable', 'Emblems'],
            ['Equippable', 'Emotes'],
            ['Equippable', 'Shaders'],
            ['Equippable', 'Ships'],
            ['Equippable', 'Sparrow Horn'],
            ['Equippable', 'Vehicle'],
            ['Item', 'Ornaments'],
            ['Item', 'Consumables'],
            ['Item', 'Materials'],
            ['Item', 'Mission'],
            ['Unknown', 'Unknown'],
        ],
    };
  }

  render() {
    return <div>
      <table>
        <thead>
          <tr>
            <th>
              {this.props.account.bungieNetUser.displayName}
              {this.props.account.bungieNetUser.displayName != this.account.userInfo.displayName ? ` (${this.account.userInfo.displayName})` : ''}
            </th>
            {this.account.characters.map(character => <td>
              <Placard background={character.backgroundPath}
                       icon={character.emblemPath}
                       right={character.level}
                       text={`${character.race.raceName} ${character.gender.genderName}`}
                       title={character.characterClass.className}
                       neutral={true}/>
            </td>)}
            <td><Placard neutral={true} title="Vault"/></td>
          </tr>
        </thead>
        <tbody>
          {this.state.buckets.map(([category, bucket]) => <tr>
            <th>{bucket}</th>
            {this.promises.map(promise => <ItemListTD promise={promise} category={category} bucket={bucket}/>)}
          </tr>)}
        </tbody>
      </table>
    </div>;
  }
}


class ItemListTD extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
        expanded: false,
    };
    this.props.promise.then(data => this.setState({items: data[this.props.category][this.props.bucket] || []}));
  }

  static cmpItem(a, b) {
    const aValue = a.primaryStat ? a.primaryStat.value : 0;
    const bValue = b.primaryStat ? b.primaryStat.value : 0;
    if (aValue != bValue)
      return bValue - aValue;
    const aTitle = a.questlineItemDef ? `${a.questlineItemDef.itemName}: ${a.itemDef.itemName}` : a.itemDef.itemName;
    const bTitle = b.questlineItemDef ? `${b.questlineItemDef.itemName}: ${b.itemDef.itemName}` : b.itemDef.itemName;
    if (aTitle < bTitle)
      return -1;
    else if (aTitle > bTitle)
      return 1;
    if (a.stackSize > b.stackSize)
      return -1;
    else if (a.stackSize < b.stackSize)
      return 1;
    return 0;
  }

  render() {
    if (!this.state.items)
      return <td>Loading...</td>;

    if (!this.state.items.length)
      return <td/>;

    var items = this.state.items.sort(ItemListTD.cmpItem);
    if (!this.state.expanded && (this.state.items.length > 4))
      items = items.slice(0, 3);
    items = items.map(item => <Item item={item}/>);
    if (this.state.items.length > 4) {
      if (!this.state.expanded) {
        const item = this.state.items[3];
        items.push(<div onClick={e => this.setState({expanded: true})}
                        style={{opacity: .3}}>
          <Item item={item}/>
        </div>);
      } else {
        items.push(<button onClick={e => {
          e.preventDefault();
          this.setState({expanded: false});
        }}>Collapse</button>);
      }
    }
    return <td>{items}</td>;
  }
}


class Item extends React.Component {
  render() {
    const item = this.props.item;
    const itemDef = item.questlineItemDef || item.itemDef;
    var title = item.questlineItemDef ? `${item.questlineItemDef.itemName}: ${item.itemDef.itemName}` : item.itemDef.itemName;
    if (item.sourceDefs && (item.sourceDefs.length == 1))
      title = <span><img width="16" height="16" src={`https://www.bungie.net${item.sourceDefs[0].icon}`} title={item.sourceDefs[0].description}/> {title}</span>;
    var text = '';
    if (item.objectives.length)
      for (let objective of item.objectives)
        text += `${objective.isComplete ? '\u2611' : '\u2610'}\u00a0${objective.objectiveDef.displayDescription || item.itemDef.itemDescription} (${objective.progress}/${objective.objectiveDef.completionValue}) `;
    else if (item.perks.length)
      for (let perk of item.perks)
        text += `${perk.isActive ? '\u2611' : '\u2610'}\u00a0${perk.perkDef.displayName} `;
    else
      text = item.itemDef.itemDescription;
    return <Placard active={item.isEquipped || (item.stateName == 'Tracked')}
                    background={itemDef.secondaryIcon}
                    icon={itemDef.icon}
                    right={item.primaryStat ? item.primaryStat.value : item.stackSize != 1 ? item.stackSize : '' }
                    text={text}
                    title={title}>
      {item.itemDef.itemDescription}
      {Boolean(item.objectives.length) && <p>
        Objectives:<br/>
        {item.objectives.map(objective => <div>{`${objective.isComplete ? '\u2611' : '\u2610'}\u00a0${objective.objectiveDef.displayDescription || item.itemDef.itemDescription} (${objective.progress}/${objective.objectiveDef.completionValue})`}</div>)}
      </p>}
      {Boolean(item.perks.length) && <p>
        Perks:<br/>
        {item.perks.map(perk => <div>{`${perk.isActive ? '\u2611' : '\u2610'}\u00a0${perk.perkDef.displayName}`}</div>)}
      </p>}
      {item.sourceDefs && Boolean(item.sourceDefs.length) && <p>
        Sources:<br/>
        {item.sourceDefs.map(source => source && <div>
          <img width="12" height="12" src={`https://www.bungie.net${source.icon}`}/>
          {source.description}
        </div>)}
      </p>}
      {item.nodeGrid && <NodeGrid grid={item.nodeGrid}/>}
      <div><button onClick={e => {e.preventDefault(); e.stopPropagation(); console.log(item)}}>Debug</button></div>
    </Placard>;
  }
}


class NodeGrid extends React.Component {
  render() {
    const grid = this.props.grid;
    const numRows = grid.map(column => column.length).reduce((a, b) => a > b ? a : b, 0);
    const rows = Array.from({length: numRows}, (_, i) => i);
    return <table>
      <tbody>
        {rows.map(rowNum => {
          const row = [];
          for (let colNum = 0; colNum < grid.length; colNum++)
            row.push(<td>{grid[colNum] && grid[colNum][rowNum] && <NodeGridNode node={grid[colNum][rowNum]}/>}</td>);
          return <tr>{row}</tr>;
        })}
      </tbody>
    </table>;
  }
}


class NodeGridNode extends React.Component {
  render() {
    const node = this.props.node;
    return <div className={`grid-node ${node.isActivated ? 'active' : node.hidden ? 'hidden' : node.stateName == 'MustSwap' ? 'unlocked' : ''}`}>
      <img src={`https://www.bungie.net${node.stepDef.icon}`}/>
      <b>{node.stepDef.nodeStepName || node.stepDef.interactionDescription}</b><br/>
      {node.stepDef.nodeStepDescription}
      {['Complete', 'Hidden', 'MustSwap', 'NoGridLevel'].indexOf(node.stateName) == -1 && ` (${node.stateName})`}
    </div>;
  }
}


class Placard extends React.Component {
  constructor(props) {
    super(props);
    this.state = {};
  }

  fixImage(src) {
    return (src && src != '/img/misc/missing_icon.png') ? 'https://www.bungie.net' + src : '';
  }

  render() {
    const props = this.props;
    const background = this.fixImage(props.background);
    const icon = this.fixImage(props.icon);
    const className = 'placard' + (props.active ? ' active' : props.neutral ? ' neutral' : '');
    const style = {};
    if (background) {
      style.backgroundImage = `url(${JSON.stringify(background)})`;
    }
    return <div className={className} onClick={e => this.setState(prev => ({open: !prev.open}))}>
      <div className="content" style={style}>
        {icon ? <img src={icon}/> : ''}
        <div className="title">{props.title}</div>
        <div className="text">{props.text}</div>
        <div className="right">{props.right}</div>
      </div>
      {this.state.open && props.children ? <div className="drawer">{props.children}</div> : ''}
    </div>;
  }
}


class APIDemo extends React.Component {
  render() {
    const promises = [
        [bungieNetPlatform.destinyService.GetAccount(2, '4611686018436064455', {definitions: true}), 'GetAccount'],
        [bungieNetPlatform.destinyService.GetAccountSummary(2, '4611686018436064455', {definitions: true}), 'GetAccountSummary'],
        [bungieNetPlatform.destinyService.GetAllItemsSummary(2, '4611686018436064455', {definitions: true}), 'GetAllItemsSummary'],
        [bungieNetPlatform.destinyService.GetVault(2, {definitions: true}), 'GetVault'],
        [bungieNetPlatform.destinyService.GetVaultSummary(2, {definitions: true}), 'GetVaultSummary'],
        [bungieNetPlatform.destinyService.GetCharacter(2, '4611686018436064455', '2305843009223046587', {definitions: true}), 'GetCharacter'],
        [bungieNetPlatform.destinyService.GetCharacterSummary(2, '4611686018436064455', '2305843009223046587', {definitions: true}), 'GetCharacterSummary'],
        [bungieNetPlatform.destinyService.GetCharacterInventory(2, '4611686018436064455', '2305843009223046587', {definitions: true}), 'GetCharacterInventory'],
        [bungieNetPlatform.destinyService.GetCharacterInventorySummary(2, '4611686018436064455', '2305843009223046587', {definitions: true}), 'GetCharacterInventorySummary'],
    ];

    return <table>
      <thead>
        <tr>{promises.map(([promise, title]) => {
          return <th>{title}</th>;
        })}</tr>
      </thead>
      <tbody>
        <tr>{promises.map(([promise, title]) => {
          return <APIDemoTD promise={promise}/>;
        })}</tr>
      </tbody>
    </table>;
  }
}


class APIDemoTD extends React.Component {
  constructor(props) {
    super(props);
    this.state = {};
  }

  render() {
    if (this.state.data) {
      const allItems = countAllItems(this.state.data);
      const uniqueItems = countUniqueItems(this.state.data);
      return <td style={{border: '1px solid black', 'white-space': 'nowrap'}}>
        {renderNestedObject(this.state.data)}<br/>
        <br/>
        All itemIds: {allItems}<br/>
        Unique itemIds: {uniqueItems.size}<br/>
        <br/>
        {Array.from(uniqueItems).sort().map(name => <div>{name}</div>)}
      </td>;
    }

    this.props.promise.then(data => this.setState({data: data.data}));
    return <td>Loading...</td>;
  }
}


function countAllItems(data) {
  var ret = 0;
  if ((data instanceof Object) && !(data instanceof Array)) {
    if (data.itemHash)
      ret++;
    data = Object.values(data);
  }
  if (data instanceof Array)
    ret += data.map(item => countAllItems(item)).reduce((a, b) => a + b, 0);
  return ret;
}


function countUniqueItems(data, seen=new Set()) {
  if ((data instanceof Object) && !(data instanceof Array)) {
    if (data.itemHash)
      seen.add(bungie.DEFS.items[data.itemHash].itemName);
    data = Object.values(data);
  }
  if (data instanceof Array)
    data.map(item => countUniqueItems(item, seen)).reduce((a, b) => a + b, 0);
  return seen;
}


function renderNestedObject(data) {
  if (data instanceof Array) {
    if (!data.length)
      return <span>[]</span>;
    return <span><button onClick={e => {let s = e.target.nextElementSibling.style; s.display = s.display ? '' : 'none';}}>*</button> [<ol style={{display: 'none'}}>
      {data.map(v => <li>{renderNestedObject(v)}</li>)}
    </ol>]</span>;
  } else if (data instanceof Object) {
    if (!Object.keys(data).length)
      return <span>{'{}'}</span>;
    return <span><button onClick={e => {let s = e.target.nextElementSibling.style; s.display = s.display ? '' : 'none';}}>*</button> {'{'}<ul style={{display: 'none'}}>
      {Object.entries(data).sort().map(([k, v]) => <li>{k}: {renderNestedObject(v)}</li>)}
    </ul>{'}'}</span>;
  } else
    return <span>{JSON.stringify(data)}</span>;
}


bungie.init(API_KEY, API_AUTH_URL)
    .then(bungie.auth.init)
    .then(function() {
      ReactDOM.render(<App/>, document.getElementById('root'));
    });
</script>
