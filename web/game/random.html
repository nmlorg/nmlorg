<!DOCTYPE html>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="render.css">

<body>


<div class="canvas main">
  <div class="controls">
    <button class="btn btn-default action-pause"></button>
    <button class="btn btn-default action-reset"></button>
    <button class="btn btn-primary pull-right action-fullscreen"></button>
  </div>
</div>


<style>
.canvas {
  position: absolute;
}

.canvas.main {
  width: 100%;
  height: 100%;
}

.controls {
  position: absolute;
  width: 100%;
  bottom: 0;
}
</style>


<script src="http://n.ml.org/nmlorg.js"></script>
<script>
nmlorg.require('nmlorg.game.autocanvas');
nmlorg.require('nmlorg.game.generator');
nmlorg.require('nmlorg.game.mob');
nmlorg.require('nmlorg.game.platforms');
nmlorg.require('nmlorg.game.player');
nmlorg.require('nmlorg.game.rectangles');
nmlorg.require('nmlorg.threed.shape');
</script>

<script>
var world = nmlorg.game.autocanvas.createWorld();
var canvas = world.canvases[0];
var pset = new nmlorg.game.platforms.PlatformSet();
var first = pset.add(10, 10);
var generator = new nmlorg.game.generator.Generator(pset);

for (var i = 0; i < 50; i++)
  generator.add();

for (var i = 0; i < pset.length; i++) {
  var platform = pset[i];
  var loc = first.localize(platform.getCenter(0, 0, 0));

  if (loc)
    world.addObject(nmlorg.game.rectangles.getRectangle(
        platform.right - platform.left, platform.rear - platform.front)).setPosition(
        loc.x, loc.y, loc.z);
}

pset.autoConnect();

var player = new nmlorg.game.player.Player(first.getCenter(0, 0, 0));
var personShape = new nmlorg.threed.shape.Shape(
    ['position', 'color'], 'triangles', [
        0, .4, -.3, 0, 0, 0, 1,
        0, .6, .5, 1, 1, 1, 1,
        0, .2, .5, 1, 1, 1, 1,

        0, .6, .5, 1, 1, 1, 1,
        0, .2, .5, 1, 1, 1, 1,
        0, .4, .9, 1, 1, 1, 1,

        0, -.4, -.3, 0, 0, 0, 1,
        0, -.6, .5, 1, 1, 1, 1,
        0, -.2, .5, 1, 1, 1, 1,

        0, -.6, .5, 1, 1, 1, 1,
        0, -.2, .5, 1, 1, 1, 1,
        0, -.4, .9, 1, 1, 1, 1,

        0, .6, .9, 1, 1, 1, 1,
        0, -.6, .9, 1, 1, 1, 1,
        0, 0, 1.2, .5, .5, .5, 1,

        0, 0, 1.2, .5, .5, .5, 1,
        0, .7, 1.5, 1, 1, 1, 1,
        0, -.7, 1.5, 1, 1, 1, 1,

        0, .7, 1.5, 1, 1, 1, 1,
        0, .6, 1.2, 1, 1, 1, 1,
        0, .8, 1.2, 1, 1, 1, 1,

        0, .6, 1.2, 1, 1, 1, 1,
        0, .8, 1.2, 1, 1, 1, 1,
        0, .7, .8, 0, 0, 0, 1,

        0, -.7, 1.5, 1, 1, 1, 1,
        0, -.6, 1.2, 1, 1, 1, 1,
        0, -.8, 1.2, 1, 1, 1, 1,

        0, -.6, 1.2, 1, 1, 1, 1,
        0, -.8, 1.2, 1, 1, 1, 1,
        .3, -.7, 1.2, 0, 0, 0, 1,

        0, 0, 1.5, 1, 1, 1, 1,
        0, -.2, 1.8018, 1, 1, 1, 1,
        0, .2, 1.8018, 1, 1, 1, 1,

        0, .3, 1.8018, 0, 0, 0, 1,
        0, -.3, 1.8018, 1, 1, 1, 1,
        -.6, .3, 1.8018, 1, 1, 1, 1,

        0, -.3, 1.8018, 1, 1, 1, 1,
        -.6, .3, 1.8018, 1, 1, 1, 1,
        -.6, -.3, 1.8018, 0, 0, 0, 1,
    ]);
var mobPhys = world.addObject(personShape);

player.viewMode = 1;

world.eachFrame = function(timeStep) {
  player.eachFrame(timeStep);

  var forwardX = 10 * Math.cos(nmlorg.degToRad(player.mob.direction));
  var forwardY = 10 * Math.sin(nmlorg.degToRad(player.mob.direction));
  var absPos = first.localize(player.mob.pos);

  mobPhys.setPosition(absPos.x, absPos.y, absPos.z);
  mobPhys.rotate(nmlorg.degToRad(player.mob.direction), 0, 0, 1);

  if (player.mob.walkTime) {
    var walkDir = player.mob.walkTime % .6 < .3 ? -15 : 15;
    var walkHeight = player.mob.walkTime % .4 < .2 ? 0 : .2;

    mobPhys.translate(0, 0, walkHeight);
    mobPhys.rotate(nmlorg.degToRad(walkDir), 1, 0, 0);
  }

  canvas.setPerspective(player.fovAngle);
  if (player.viewMode == 0)
    canvas.setCamera(absPos.x,
                     absPos.y,
                     absPos.z + 1.7018,
                     absPos.x + forwardX,
                     absPos.y + forwardY,
                     absPos.z + 1.7018 + 10 * Math.sin(nmlorg.degToRad(player.eyeAngle)),
                     0, 0, 1);
  else if (player.viewMode == 1)
    canvas.setCamera(absPos.x - forwardX,
                     absPos.y - forwardY,
                     absPos.z + 1.7018 + 3,
                     absPos.x,
                     absPos.y,
                     absPos.z + 1.7018,
                     0, 0, 1);
  else if (player.viewMode == 2)
    canvas.setCamera(absPos.x - forwardX,
                     absPos.y - forwardY,
                     absPos.z + 1.7018 + 50,
                     absPos.x, absPos.y, absPos.z + 1.7018,
                     forwardX, forwardY, 0);
};

world.start();
</script>
