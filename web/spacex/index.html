<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="button.css">
<script src="button.js"></script>
<script src="camera.js"></script>
<link rel="stylesheet" href="compass.css">
<script src="compass.js"></script>
<link rel="stylesheet" href="console.css">
<script src="matrix.js"></script>
<link rel="stylesheet" href="pitchmodel.css">
<script src="pitchmodel.js"></script>
<link rel="stylesheet" href="rollmodel.css">
<script src="rollmodel.js"></script>
<script src="vehicle.js"></script>

<div id="viewport"></div>

<script>
var viewPort = document.getElementById('viewport');
var bg = document.createElement('img');

viewPort.appendChild(bg);
bg.src = 'http://n.ml.org/spacex/view-of-earth-from-space-03.jpg';
bg.style.width = '100%';
bg.style.height = '100%';

var viewBar = new spacex.ButtonBar().attach(viewPort, 22, 27);
var frontButton = viewBar.add('Front View').active(true).click(function() {
  frontButton.active(true);
  rearButton.active(false);
  bg.src = 'http://n.ml.org/spacex/view-of-earth-from-space-03.jpg';
});
var rearButton = viewBar.add('Rear View').click(function() {
  frontButton.active(false);
  rearButton.active(true);
  bg.src = 'http://n.ml.org/spacex/view-of-earth-from-space-04.jpg';
});

var vehicle = new spacex.Vehicle({velocity: 100});
var rollModel = new spacex.RollModel(vehicle).attach(viewPort, 1, 1);
var pitchModel = new spacex.PitchModel(vehicle).attach(viewPort, 22, 1);
var compass = new spacex.Compass(vehicle).attach(viewPort, 43, 1);
var upUntil = 0, downUntil = 0, leftUntil = 0, rightUntil = 0;
var autoLevel = true;

var buttonBar = new spacex.ButtonBar().attach(viewPort, 11, 22);
var upButton = buttonBar.add('Pull Up').click(function() {
  if (upUntil >= Date.now())
    upUntil = 0;
  else
    upUntil = Date.now() + 5000;
});
var downButton = buttonBar.add('Push Down').click(function() {
  if (downUntil >= Date.now())
    downUntil = 0;
  else
    downUntil = Date.now() + 5000;
});
var leftButton = buttonBar.add('Bank Left').click(function() {
  if (leftUntil >= Date.now())
    leftUntil = 0;
  else
    leftUntil = Date.now() + 5000;
});
var rightButton = buttonBar.add('Bank Right').click(function() {
  if (rightUntil >= Date.now())
    rightUntil = 0;
  else
    rightUntil = Date.now() + 5000;
});

var levelButton = new spacex.Button('Auto Level').attach(viewPort, 22, 22).click(function() {
  autoLevel = !autoLevel;
});

var yawButton = new spacex.Button('').attach(viewPort, 48, 17);
var pitchButton = new spacex.Button('').attach(viewPort, 27, 17);
var rollButton = new spacex.Button('').attach(viewPort, 6, 17);

var posBar = new spacex.ButtonBar().attach(viewPort, 48, 23);
var xButton = posBar.add('0');
var yButton = posBar.add('0');
var zButton = posBar.add('0');

var last = 0;
function anim(now) {
  if (!last)
    last = now;
  var dt = (now - last) / 1000;
  last = now;

  vehicle.pitch += 20 * (Math.random() - .5) * dt;
  vehicle.roll += 20 * (Math.random() - .5) * dt;

  levelButton.active(autoLevel);
  if (autoLevel) {
    if (vehicle.pitch > 5)
      downUntil = Math.max(downUntil, Date.now() + 1000);
    else if (vehicle.pitch < -5)
      upUntil = Math.max(upUntil, Date.now() + 1000);

    if (vehicle.roll > 5)
      leftUntil = Math.max(leftUntil, Date.now() + 1000);
    else if (vehicle.roll < -5)
      rightUntil = Math.max(rightUntil, Date.now() + 1000);
  }

  if (downUntil >= Date.now()) {
    downButton.active(true);
    vehicle.pitch -= 5 * dt;
  } else
    downButton.active(false);
  if (upUntil >= Date.now()) {
    upButton.active(true);
    vehicle.pitch += 5 * dt;
  } else
    upButton.active(false);

  if (leftUntil >= Date.now()) {
    leftButton.active(true);
    vehicle.roll -= 5 * dt;
  } else
    leftButton.active(false);

  if (rightUntil >= Date.now()) {
    rightButton.active(true);
    vehicle.roll += 5 * dt;
  } else
    rightButton.active(false);

  vehicle.yaw += vehicle.roll / 10 * dt;

  vehicle.compound(dt);
  yawButton.title(Math.floor(vehicle.yaw * 10) / 10 + ' \u00b0');
  pitchButton.title(Math.floor(vehicle.pitch) + ' \u00b0');
  rollButton.title(Math.floor(vehicle.roll) + ' \u00b0');
  xButton.title(Math.floor(vehicle.x) + ' m');
  yButton.title(Math.floor(vehicle.y) + ' m');
  zButton.title(Math.floor(vehicle.z) + ' m');
  rollModel.draw(dt);
  pitchModel.draw(dt);
  compass.draw(dt);
  requestAnimationFrame(anim);
}

requestAnimationFrame(anim);
</script>
