<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<div id="viewport" style="background-image: url('http://n.ml.org/spacex/view-of-earth-from-space-03.jpg')">
  <div class="row">
    <div style="height: 20vw; width: 20vw" data-widget="roll-gauge"></div>
    <div style="height: 20vw; width: 20vw" data-widget="pitch-gauge"></div>
    <div style="height: 20vw; width: 20vw" data-widget="compass"></div>
    <div style="height: 18vw; top: 1vw; width: 35vw" data-widget="globe"></div>
  </div>
  <div class="row">
    <div class="button-bar button-bar-vert">
      <button data-set="background"
              data-value="http://n.ml.org/spacex/view-of-earth-from-space-03.jpg">Front View</button>
      <button data-set="background"
              data-value="http://n.ml.org/spacex/view-of-earth-from-space-04.jpg">Rear View</button>
    </div>
    <div class="button-bar button-bar-vert">
      <button data-pattern="Math.floor(vehicle.velocity) + ' m\u2215s'"></button>
      <button data-pattern="Math.floor(Math.abs(vehicle.lat) * 10) / 10 + ' \u00b0 ' + (vehicle.lat > 0 ? 'N' : 'S')"></button>
      <button data-pattern="Math.floor(Math.abs(vehicle.lon) * 10) / 10 + ' \u00b0 ' + (vehicle.lon > 0 ? 'E' : 'W')"></button>
      <button data-pattern="Math.floor(vehicle.z / 1000) + ' km'"></button>
    </div>
    <div class="col">
      <button style="left: 5vw" data-thrust="up">Pull Up</button>
      <div class="button-bar button-bar-horiz">
        <button data-thrust="left">Bank Left</button>
        <button data-thrust="right">Bank Right</button>
      </div>
      <button style="left: 5vw" data-thrust="down">Push Down</button>
    </div>
  </div>
</div>

<link rel="stylesheet" href="button.css">
<script src="camera.js"></script>
<link rel="stylesheet" href="compass.css">
<script src="compass.js"></script>
<link rel="stylesheet" href="console.css">
<script src="globe.js"></script>
<link rel="stylesheet" href="globe.css">
<script src="matrix.js"></script>
<script src="model.js"></script>
<link rel="stylesheet" href="pitchmodel.css">
<script src="pitchmodel.js"></script>
<link rel="stylesheet" href="rollmodel.css">
<script src="rollmodel.js"></script>
<script src="vehicle.js"></script>

<script src="https://www.webglearth.com/v2/api.js"></script>

<script>
var viewPort = document.getElementById('viewport');
var vehicle = new spacex.Vehicle({velocity: 27359});
var thrust = {'down': 0, 'left': 0, 'right': 0, 'up': 0};
var widgets = [];
var widgetMap = {
    'compass': spacex.Compass,
    'globe': spacex.Globe,
    'pitch-gauge': spacex.PitchModel,
    'roll-gauge': spacex.RollModel,
};
var divs = document.getElementsByTagName('div');

for (var i = 0; i < divs.length; i++) {
  var div = divs[i];

  if (widgetMap[div.dataset.widget]) {
    var textContent = div.textContent;
    div.textContent = '';
    var widget = new widgetMap[div.dataset.widget](vehicle, textContent).attach(div);
    if (widget.draw)
      widgets.push(widget.draw.bind(widget));
  }
}

var buttonValues = {};

Object.defineProperties(buttonValues, {
    'background': {
        'get': function() {
          if (viewPort.style.backgroundImage.match(/^url[(]['"]?(.*)['"]?[)]$/))
            return RegExp.$1;
        },
        'set': function(value) {
          viewPort.style.backgroundImage = 'url(' + value + ')';
        },
    },
});

var buttons = document.getElementsByTagName('button');
var buttonsFor = {};

for (var i = 0; i < buttons.length; i++) {
  var button = buttons[i];

  if (button.dataset.pattern)
    widgets.push(function(dt) {
      this.textContent = eval(this.dataset.pattern);
    }.bind(button));

  if (button.dataset.set && button.dataset.value) {
    var name = button.dataset.set, value = button.dataset.value;
    if (!buttonsFor[name])
      buttonsFor[name] = [];
    buttonsFor[name].push(button);
    if (buttonValues[name] == value)
      button.className = 'active';
    button.style.cursor = 'pointer';
    button.addEventListener('click', function(e) {
      var name = this.dataset.set, value = this.dataset.value;
      for (var i = 0; i < buttonsFor[name].length; i++)
        buttonsFor[name][i].className = '';
      this.className = 'active';
      buttonValues[name] = value;
    });
  } else if (button.dataset.thrust) {
    widgets.push(function(dt, now) {
      this.className = thrust[this.dataset.thrust] >= Date.now() ? 'active' : '';
    }.bind(button));
    button.style.cursor = 'pointer';
    button.addEventListener('click', function(e) {
      var direction = this.dataset.thrust;
      var now = Date.now();
      if (thrust[direction] >= now)
        thrust[direction] = 0;
      else
        thrust[direction] = now + 5000;
    });
  }
}

var last = 0;
requestAnimationFrame(function anim(now) {
  if (!last)
    last = now;
  var dt = (now - last) / 1000;
  last = now;
  now = Date.now();

  vehicle.pitch += 20 * (Math.random() - .5) * dt;
  vehicle.roll += 20 * (Math.random() - .5) * dt;

  if (thrust.down >= now)
    vehicle.pitch -= 5 * dt;

  if (thrust.up >= now)
    vehicle.pitch += 5 * dt;

  if (thrust.left >= now)
    vehicle.roll -= 5 * dt;

  if (thrust.right >= now)
    vehicle.roll += 5 * dt;

  vehicle.yaw += vehicle.roll / 10 * dt;
  vehicle.compound(dt);

  for (var i = 0; i < widgets.length; i++)
    widgets[i](dt);

  requestAnimationFrame(anim);
});
</script>
