<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<div id="viewport" style="background-image: url('http://n.ml.org/spacex/view-of-earth-from-space-03.jpg')">
  <div class="row">
    <div style="height: 20vw; width: 20vw" data-widget="roll-gauge"></div>
    <div style="height: 20vw; width: 20vw" data-widget="pitch-gauge"></div>
    <div style="height: 20vw; width: 20vw" data-widget="compass"></div>
    <div style="height: 18vw; top: 1vw; width: 35vw" data-widget="globe"></div>
  </div>
  <div class="row">
    <div class="col">
      <div class="button-bar button-bar-vert">
        <button data-set="background"
                data-value="http://n.ml.org/spacex/view-of-earth-from-space-03.jpg">Front View</button>
        <button data-set="background"
                data-value="http://n.ml.org/spacex/view-of-earth-from-space-04.jpg">Rear View</button>
      </div>
      <button data-pattern="Math.round(vehicle.velocity) + ' m\u2215s'"></button>
    </div>
    <div class="col">
      <button style="left: 5vw" data-thrust="up">Pull Up</button>
      <div class="button-bar button-bar-horiz">
        <button data-thrust="left">Bank Left</button>
        <button data-thrust="right">Bank Right</button>
      </div>
      <button style="left: 5vw" data-thrust="down">Push Down</button>
    </div>
    <div class="col">
      <div class="button-bar button-bar-horiz">
        <button class="small" onclick="targeting.yaw = true; targeting.latlon = targeting.roll = false; target.yaw -= 1;">&#x21e9;</button>
        <button data-pattern="fmtCompass(vehicle.yaw)"></button>
        <button data-pattern="'\u2192 ' + fmtCompass(target.yaw)"></button>
        <button class="small" onclick="targeting.yaw = true; targeting.latlon = targeting.roll = false; target.yaw += 1;">&#x21e7;</button>
      </div>
      <div class="button-bar button-bar-horiz">
        <button class="small" onclick="targeting.pitch = true; targeting.z = false; target.pitch -= 1;">&#x21e9;</button>
        <button data-pattern="fmtDeg(vehicle.pitch, 'down', 'up')"></button>
        <button data-pattern="'\u2192 ' + fmtDeg(target.pitch, 'down', 'up', 10)"></button>
        <button class="small" onclick="targeting.pitch = true; targeting.z = false; target.pitch += 1;">&#x21e7;</button>
      </div>
      <div class="button-bar button-bar-horiz">
        <button class="small" onclick="targeting.roll = true; targeting.latlon = targeting.yaw = false; target.roll -= 1;">&#x21e9;</button>
        <button data-pattern="fmtDeg(vehicle.roll, 'left', 'right')"></button>
        <button data-pattern="'\u2192 ' + fmtDeg(target.roll, 'left', 'right', 10)"></button>
        <button class="small" onclick="targeting.roll = true; targeting.latlon = targeting.yaw = false; target.roll += 1;">&#x21e7;</button>
      </div>
    </div>
    <div class="col">
      <div class="button-bar button-bar-horiz">
        <button class="small" onclick="targeting.latlon = true; targeting.yaw = targeting.roll = false; target.lat -= 1;">&#x21e9;</button>
        <button class="small" onclick="targeting.latlon = true; targeting.yaw = targeting.roll = false; target.lat -= .01;">&#x2193;</button>
        <button data-pattern="fmtDeg(vehicle.lat, 'S', 'N', 10)"></button>
        <button data-pattern="'\u2192 ' + fmtDeg(target.lat, 'S', 'N', 100)"></button>
        <button class="small" onclick="targeting.latlon = true; targeting.yaw = targeting.roll = false; target.lat += .01;">&#x2191;</button>
        <button class="small" onclick="targeting.latlon = true; targeting.yaw = targeting.roll = false; target.lat += 1;">&#x21e7;</button>
      </div>
      <div class="button-bar button-bar-horiz">
        <button class="small" onclick="targeting.latlon = true; targeting.yaw = targeting.roll = false; target.lon -= 1;">&#x21e9;</button>
        <button class="small" onclick="targeting.latlon = true; targeting.yaw = targeting.roll = false; target.lon -= .01;">&#x2193;</button>
        <button data-pattern="fmtDeg(vehicle.lon, 'W', 'E', 10)"></button>
        <button data-pattern="'\u2192 ' + fmtDeg(target.lon, 'W', 'E', 100)"></button>
        <button class="small" onclick="targeting.latlon = true; targeting.yaw = targeting.roll = false; target.lon += .01;">&#x2191;</button>
        <button class="small" onclick="targeting.latlon = true; targeting.yaw = targeting.roll = false; target.lon += 1;">&#x21e7;</button>
      </div>
      <div class="button-bar button-bar-horiz">
        <button class="small" onclick="targeting.z = true; targeting.pitch = false; target.z -= 10000;">&#x21e9;</button>
        <button class="small" onclick="targeting.z = true; targeting.pitch = false; target.z -= 100;">&#x2193;</button>
        <button data-pattern="Math.round(vehicle.z / 1000) + ' km'"></button>
        <button data-pattern="'\u2192 ' + Math.round(target.z / 100) / 10 + ' km'"></button>
        <button class="small" onclick="targeting.z = true; targeting.pitch = false; target.z += 100;">&#x2191;</button>
        <button class="small" onclick="targeting.z = true; targeting.pitch = false; target.z += 10000;">&#x21e7;</button>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="button.css">
<script src="camera.js"></script>
<link rel="stylesheet" href="compass.css">
<script src="compass.js"></script>
<link rel="stylesheet" href="console.css">
<script src="globe.js"></script>
<link rel="stylesheet" href="globe.css">
<script src="matrix.js"></script>
<script src="model.js"></script>
<link rel="stylesheet" href="pitchmodel.css">
<script src="pitchmodel.js"></script>
<link rel="stylesheet" href="rollmodel.css">
<script src="rollmodel.js"></script>
<script src="vehicle.js"></script>

<script src="https://www.webglearth.com/v2/api.js"></script>

<script>
var viewPort = document.getElementById('viewport');
var vehicle = new spacex.Vehicle({velocity: 27359});
var thrust = {'down': 0, 'left': 0, 'right': 0, 'up': 0};
var target = {'lat': 37.39, 'lon': -122.08, 'z': 382500, 'yaw': 0, 'pitch': 0, 'roll': 0};
var targeting = {'latlon': false, 'z': false, 'yaw': false, 'pitch': false, 'roll': false};
var widgets = [];
var widgetMap = {
    'compass': spacex.Compass,
    'globe': spacex.Globe,
    'pitch-gauge': spacex.PitchModel,
    'roll-gauge': spacex.RollModel,
};
var divs = document.getElementsByTagName('div');

for (var i = 0; i < divs.length; i++) {
  var div = divs[i];

  if (widgetMap[div.dataset.widget]) {
    var widget = new widgetMap[div.dataset.widget](vehicle).attach(div);
    if (widget.draw)
      widgets.push(widget.draw.bind(widget));
  }
}

var buttonValues = {};

Object.defineProperties(buttonValues, {
    'background': {
        'get': function() {
          if (viewPort.style.backgroundImage.match(/^url[(]['"]?(.*)['"]?[)]$/))
            return RegExp.$1;
        },
        'set': function(value) {
          viewPort.style.backgroundImage = 'url(' + value + ')';
        },
    },
});

var buttons = document.getElementsByTagName('button');
var buttonsFor = {};

for (var i = 0; i < buttons.length; i++) {
  var button = buttons[i];

  if (button.dataset.pattern)
    widgets.push(function(dt) {
      this.textContent = eval(this.dataset.pattern);
    }.bind(button));

  if (button.dataset.set && button.dataset.value) {
    var name = button.dataset.set, value = button.dataset.value;
    if (!buttonsFor[name])
      buttonsFor[name] = [];
    buttonsFor[name].push(button);
    if (buttonValues[name] == value)
      button.className = 'active';
    button.style.cursor = 'pointer';
    button.addEventListener('click', function(e) {
      var name = this.dataset.set, value = this.dataset.value;
      for (var i = 0; i < buttonsFor[name].length; i++)
        buttonsFor[name][i].className = '';
      this.className = 'active';
      buttonValues[name] = value;
    });
  } else if (button.dataset.thrust) {
    widgets.push(function(dt, now) {
      this.className = thrust[this.dataset.thrust] >= Date.now() ? 'active' : '';
    }.bind(button));
    button.style.cursor = 'pointer';
    button.addEventListener('click', function(e) {
      var direction = this.dataset.thrust;
      var now = Date.now();
      if (thrust[direction] >= now)
        thrust[direction] = 0;
      else
        thrust[direction] = now + 5000;
    });
  }
}

function fmtCompass(deg) {
  var s = Math.round(deg) + ' \u00b0 ';
  if ((deg < -157.5) || (deg > 157.5))
    return s + 'S';
  else if (deg < -112.2)
    return s + 'SW';
  else if (deg < -67.5)
    return s + 'W';
  else if (deg < -22.5)
    return s + 'NW';
  else if (deg < 22.5)
    return s + 'N';
  else if (deg < 67.5)
    return s + 'NE';
  else if (deg < 112.5)
    return s + 'E';
  else
    return s + 'SE';
}

function fmtDeg(deg, lower, upper, precision) {
  precision = precision || 1;
  return Math.round(deg * precision) / precision + ' \u00b0 ' + (deg < 0 ? lower : upper);
}

var last = 0;
requestAnimationFrame(function anim(now) {
  if (!last)
    last = now;
  var dt = (now - last) / 1000;
  last = now;
  now = Date.now();

  vehicle.pitch += 20 * (Math.random() - .5) * dt;
  vehicle.roll += 20 * (Math.random() - .5) * dt;

  if (targeting.latlon || targeting.yaw || targeting.roll) {
    if (targeting.latlon || targeting.yaw) {
      if (targeting.latlon)
        target.yaw = 90 - Math.atan2(target.lat - vehicle.lat, target.lon - vehicle.lon) * 180 / Math.PI;

      target.roll = 10 * Math.max(-2, Math.min(2, target.yaw - vehicle.yaw));
    }

    if (vehicle.roll > target.roll + 1) {
      thrust.left = Math.max(thrust.left, now + 100);
      thrust.right = 0;
    } else if (vehicle.roll < target.roll - 1) {
      thrust.left = 0;
      thrust.right = Math.max(thrust.right, now + 100);
    }
  }

  if (targeting.z || targeting.pitch) {
    if (targeting.z)
      target.pitch = Math.max(-10000, Math.min(10000, target.z - vehicle.z)) / 1000;

    if (vehicle.pitch > target.pitch + 1) {
      thrust.down = Math.max(thrust.down, now + 100);
      thrust.up = 0;
    } else if (vehicle.pitch < target.pitch - 1) {
      thrust.down = 0;
      thrust.up = Math.max(thrust.up, now + 100);
    }
  }

  if (thrust.down >= now)
    vehicle.pitch -= 5 * dt;

  if (thrust.up >= now)
    vehicle.pitch += 5 * dt;

  if (thrust.left >= now)
    vehicle.roll -= 5 * dt;

  if (thrust.right >= now)
    vehicle.roll += 5 * dt;

  vehicle.yaw += vehicle.roll / 10 * dt;
  vehicle.compound(dt);

  for (var i = 0; i < widgets.length; i++)
    widgets[i](dt);

  requestAnimationFrame(anim);
});
</script>
